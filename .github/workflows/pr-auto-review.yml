name: ü§ñ PR Auto-Review & Approve

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write
  checks: read

jobs:
  # Analyze PR for auto-review eligibility
  analyze-pr:
    name: üìä Analyze PR
    runs-on: ubuntu-latest
    outputs:
      should_review: ${{ steps.analysis.outputs.should_review }}
      review_decision: ${{ steps.analysis.outputs.review_decision }}
      review_comment: ${{ steps.analysis.outputs.review_comment }}
      safe_to_merge: ${{ steps.analysis.outputs.safe_to_merge }}
      pr_number: ${{ steps.export-pr-number.outputs.pr_number }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR details
        id: pr-details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            let prNumber;
            
            // Handle different event types
            if (context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            } else if (context.payload.review) {
              prNumber = context.payload.review.pull_request.number;
            } else if (context.payload.inputs && context.payload.inputs.pr_number) {
              prNumber = parseInt(context.payload.inputs.pr_number);
            } else {
              throw new Error('Could not determine PR number from event context');
            }
            
            console.log(`Processing PR #${prNumber}`);
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            return {
              prNumber: prNumber,
              pr: pr,
              files: files,
              reviews: reviews,
              fileCount: files.length,
              additions: pr.additions,
              deletions: pr.deletions,
              changedFiles: pr.changed_files
            };
      
      - name: Export PR number
        id: export-pr-number
        run: |
          PR_NUM=$(echo '${{ steps.pr-details.outputs.result }}' | jq -r '.prNumber')
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
      
      - name: Analyze PR for auto-review
        id: analysis
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const data = JSON.parse('${{ steps.pr-details.outputs.result }}');
            const pr = data.pr;
            const files = data.files;
            const reviews = data.reviews;
            
            console.log(`Analyzing PR #${pr.number}: ${pr.title}`);
            console.log(`Files changed: ${data.fileCount}, +${data.additions}/-${data.deletions}`);
            
            let shouldReview = true;
            let reviewDecision = 'COMMENT'; // APPROVE, REQUEST_CHANGES, or COMMENT
            let safeToMerge = false;
            let reasons = [];
            
            // Skip if already approved by a human
            const hasHumanApproval = reviews.some(r => 
              r.state === 'APPROVED' && 
              r.user.type !== 'Bot'
            );
            
            if (hasHumanApproval) {
              console.log('Already has human approval, skipping auto-review');
              shouldReview = false;
            }
            
            // Skip draft PRs
            if (pr.draft) {
              console.log('Draft PR, skipping auto-review');
              shouldReview = false;
            }
            
            // Check PR author
            const isBot = pr.user.type === 'Bot';
            const isDependabot = pr.user.login.includes('dependabot');
            const isGithubActions = pr.user.login.includes('github-actions');
            
            // Analyze file changes
            const onlyDocs = files.every(f => 
              f.filename.match(/\.(md|txt|rst)$/i) ||
              f.filename.startsWith('docs/')
            );
            
            const onlyTests = files.every(f => 
              f.filename.match(/test_.*\.py$/) ||
              f.filename.startsWith('tests/') ||
              f.filename.match(/\.test\.(js|ts)$/)
            );
            
            const onlyConfig = files.every(f => 
              f.filename.match(/\.(yml|yaml|json|toml|ini|cfg)$/i) ||
              f.filename.startsWith('.github/') ||
              f.filename.match(/^(\..*rc|.*\.config\.(js|ts))$/)
            );
            
            const hasDependencyUpdates = files.some(f =>
              f.filename.match(/^(package\.json|requirements\.txt|Gemfile|go\.mod|Cargo\.toml)$/)
            );
            
            const onlyFormatting = files.every(f => {
              // Check if changes are only whitespace/formatting
              const patch = f.patch || '';
              const meaningfulChanges = patch.split('\n').filter(line => {
                if (!line.startsWith('+') && !line.startsWith('-')) return false;
                if (line.match(/^[+-]\s*$/)) return false; // Empty lines
                return true;
              });
              return meaningfulChanges.length < 10; // Small formatting changes
            });
            
            const smallPR = data.additions + data.deletions < 100;
            const tinyPR = data.additions + data.deletions < 20;
            
            // Auto-approve scenarios
            if (isDependabot && hasDependencyUpdates && tinyPR) {
              reviewDecision = 'APPROVE';
              safeToMerge = true;
              reasons.push('‚úÖ Dependabot dependency update (small)');
            } else if (isGithubActions && onlyConfig) {
              reviewDecision = 'APPROVE';
              safeToMerge = true;
              reasons.push('‚úÖ GitHub Actions workflow update');
            } else if (onlyDocs && smallPR) {
              reviewDecision = 'APPROVE';
              safeToMerge = true;
              reasons.push('‚úÖ Documentation-only changes');
            } else if (onlyTests && smallPR) {
              reviewDecision = 'APPROVE';
              safeToMerge = true;
              reasons.push('‚úÖ Test-only changes');
            } else if (onlyFormatting && tinyPR) {
              reviewDecision = 'APPROVE';
              reasons.push('‚úÖ Code formatting only');
            } else if (isBot && tinyPR) {
              reviewDecision = 'APPROVE';
              reasons.push('‚úÖ Bot-created small change');
            } else if (smallPR && pr.title.toLowerCase().match(/^(fix|docs|test|chore|style):/)) {
              reviewDecision = 'COMMENT';
              reasons.push('‚ÑπÔ∏è Small conventional commit change');
            } else {
              reviewDecision = 'COMMENT';
              reasons.push('‚ÑπÔ∏è Manual review recommended');
            }
            
            // Security checks
            const hasSecurityFiles = files.some(f => 
              f.filename.match(/^(\.env|secrets|credentials|keys|\.pem|\.key)/) ||
              f.filename.includes('password')
            );
            
            if (hasSecurityFiles) {
              reviewDecision = 'REQUEST_CHANGES';
              safeToMerge = false;
              reasons.push('‚ö†Ô∏è Security-sensitive files detected - manual review required');
            }
            
            const reviewComment = `## ü§ñ Automated PR Review
            
            **PR Analysis:**
            - **Files Changed:** ${data.fileCount}
            - **Lines Changed:** +${data.additions}/-${data.deletions}
            - **Author:** @${pr.user.login} ${pr.user.type === 'Bot' ? '(Bot)' : '(Human)'}
            - **Decision:** ${reviewDecision}
            
            **Analysis Results:**
            ${reasons.map(r => r).join('\n')}
            
            ${reviewDecision === 'APPROVE' ? 
            `‚úÖ **This PR is approved for merging.**
            
            ${safeToMerge ? 'üîÄ Adding safe-to-merge label for auto-merge eligibility.' : '‚ö†Ô∏è Manual merge recommended despite approval.'}` : 
            reviewDecision === 'REQUEST_CHANGES' ? 
            `‚ùå **Changes requested - manual review required.**
            
            Please address the concerns above before merging.` : 
            `‚ÑπÔ∏è **Manual review recommended.**
            
            This PR requires human review before merging.`}
            
            ---
            *Automated by PR Auto-Review System*`;
            
            return {
              should_review: shouldReview,
              review_decision: reviewDecision,
              review_comment: reviewComment,
              safe_to_merge: safeToMerge
            };
      
      - name: Check CI status
        id: ci-status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const data = JSON.parse('${{ steps.pr-details.outputs.result }}');
            const prNumber = data.prNumber;
            const pr = data.pr;
            
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            const allPassed = checks.check_runs.length > 0 && checks.check_runs.every(run => 
              run.status === 'completed' && run.conclusion === 'success'
            );
            
            const hasPending = checks.check_runs.some(run => run.status !== 'completed');
            
            console.log(`CI Status: ${allPassed ? 'PASSED' : hasPending ? 'PENDING' : 'FAILED'}`);
            console.log(`Total checks: ${checks.check_runs.length}`);
            
            // Update review decision if CI is failing
            let reviewDecision = '${{ steps.analysis.outputs.review_decision }}';
            if (!allPassed && !hasPending && reviewDecision === 'APPROVE') {
              console.log('‚ö†Ô∏è CI checks failing - changing review from APPROVE to COMMENT');
              reviewDecision = 'COMMENT';
            }
            
            return {
              all_passed: allPassed,
              has_pending: hasPending,
              check_count: checks.check_runs.length,
              review_decision_final: reviewDecision
            };

  # Submit automated review
  submit-review:
    name: ‚úÖ Submit Review
    runs-on: ubuntu-latest
    needs: analyze-pr
    if: needs.analyze-pr.outputs.should_review == 'true'
    
    steps:
      - name: Submit PR review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ needs.analyze-pr.outputs.pr_number }}');
            const decision = '${{ needs.analyze-pr.outputs.review_decision }}';
            const comment = `${{ needs.analyze-pr.outputs.review_comment }}`;
            
            if (!prNumber) {
              console.error('Could not determine PR number');
              return;
            }
            
            console.log(`Submitting ${decision} review for PR #${prNumber}`);
            
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: decision,
                body: comment
              });
              
              console.log(`Review submitted: ${decision}`);
            } catch (error) {
              console.error('Error submitting review:', error.message);
              
              // Fallback to comment if review fails
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
      
      - name: Add safe-to-merge label
        if: needs.analyze-pr.outputs.safe_to_merge == 'true' && needs.analyze-pr.outputs.review_decision == 'APPROVE'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ needs.analyze-pr.outputs.pr_number }}');
            
            if (!prNumber) {
              console.error('Could not determine PR number');
              return;
            }
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['safe-to-merge', 'auto-approved']
            });
            
            console.log('Added safe-to-merge and auto-approved labels');
      
      - name: Add auto-merge label for eligible PRs
        if: needs.analyze-pr.outputs.safe_to_merge == 'true' && needs.analyze-pr.outputs.review_decision == 'APPROVE'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ needs.analyze-pr.outputs.pr_number }}');
            
            if (!prNumber) {
              console.error('Could not determine PR number - skipping auto-merge label');
              return;
            }
            
            // Add auto-merge label to trigger the auto-merge workflow
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['auto-merge']
            });
            
            console.log('Added auto-merge label - PR is eligible for automatic merging');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `üîÄ **Auto-Merge Enabled**
              
              This PR has been automatically approved and is now eligible for auto-merge.
              
              The PR will be automatically merged once all CI checks pass.
              
              To disable auto-merge, remove the \`auto-merge\` label.
              
              ---
              *Automated by PR Auto-Review System*`
            });

  # Monitoring and reporting
  review-summary:
    name: üìä Review Summary
    runs-on: ubuntu-latest
    needs: [analyze-pr, submit-review]
    if: always()
    
    steps:
      - name: Generate summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number || 'unknown';
            const shouldReview = '${{ needs.analyze-pr.outputs.should_review }}';
            const decision = '${{ needs.analyze-pr.outputs.review_decision }}';
            const safeToMerge = '${{ needs.analyze-pr.outputs.safe_to_merge }}';
            
            console.log('## PR Auto-Review Summary');
            console.log(`PR #${prNumber}`);
            console.log(`Should Review: ${shouldReview}`);
            console.log(`Decision: ${decision}`);
            console.log(`Safe to Merge: ${safeToMerge}`);
            
            if (shouldReview === 'true') {
              console.log('‚úÖ Review submitted successfully');
            } else {
              console.log('‚ÑπÔ∏è Review skipped (already approved or draft)');
            }
